<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квест 4: Восстанови последовательность - Мир Чехова</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Lora:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
</head>
<body class="quest-active">

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../logo.png" alt="Логотип Квеста" width="30" height="30" class="d-inline-block align-text-top me-2">
                <span class="brand-main-text">Мир Чехова</span>
                <span class="brand-tagline ms-2">| грустные оптимисты</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../1/quest_page_1.html">
                            <span class="quest-label d-block">Квест 1:</span>
                            <span class="quest-title d-block">Шуточка</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../2/quest_page_1.html">
                            <span class="quest-label d-block">Квест 2:</span>
                            <span class="quest-title d-block">Толстый и тонкий</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../3/quest_page_1.html">
                            <span class="quest-label d-block">Квест 3:</span>
                            <span class="quest-title d-block">Злоумышленник</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../4/quest_page_1.html">
                            <span class="quest-label d-block">Квест 4:</span>
                            <span class="quest-title d-block">Спать хочется</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../5/quest_page_1.html">
                            <span class="quest-label d-block">Квест 5:</span>
                            <span class="quest-title d-block">Дорогая собака</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../6/quest_page_1.html">
                            <span class="quest-label d-block">Квест 6:</span>
                            <span class="quest-title d-block">Пари</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../7/quest_page_1.html">
                            <span class="quest-label d-block">Квест 7:</span>
                            <span class="quest-title d-block">Не в духе</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../8/quest_page_1.html">
                            <span class="quest-label d-block">Квест 8:</span>
                            <span class="quest-title d-block">Биография</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container quest-page-container my-5 pt-4 pb-5">
        <div class="row">
            <div class="col-12 text-center">
                <h2 class="quest-question mb-3">Расположите события в хронологическом порядке</h2>
                <p class="lead text-muted mb-4">Расположите события рассказа А.П. Чехова "Не в духе" в правильной хронологической последовательности, перетаскивая блоки.</p>
            </div>
        </div>

        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">
                <div id="sortable-list" class="list-group">
                    <!-- Блоки событий будут добавлены JavaScript -->
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12 text-center">
                <button type="button" class="btn btn-start-quest btn-lg" id="check-sequence-button">Проверить последовательность</button>
                <p id="quest-feedback" class="quest-feedback-message mt-3"> </p>
            </div>
        </div>
        <div class="row mt-3 mb-5">
            <div class="col-12 text-center">
                <a href="quest_page_5.html" id="next-quest-button" class="btn btn-start-quest d-none">Следующий этап</a>
            </div>
        </div>
    </main>

    <div id="chekhov-corner">
        <img src="../placeholder-chekhov.png" alt="Антон Чехов" title="Антон Павлович Чехов">
    </div>

    <footer class="footer mt-auto py-3">
        <div class="container text-center">
            <span class="text-muted">© 2024 Литературный квест "Мир Чехова". Все права защищены.</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        const eventsData = [
            { id: 1, text: "Варька убивает ребенка и засыпает." },
            { id: 2, text: "Варька укладывает ребенка в люльку и начинает его качать" },
            { id: 3, text: "Варька мечтает о сне и представляет себе разные способы уснуть" },
            { id: 4, text: "Варька выполняет многочисленные поручения хозяев, испытывая изнеможение" },
            { id: 5, text: "Варька просыпается от крика ребенка и понимает, что ей снова не дадут спать" },
            { id: 6, text: "Хозяева ругают Варьку за медлительность и заставляют ее снова качать ребенка" },
            { id: 7, text: "Варька вспоминает о своей прежней жизни в деревне, где ей было спокойно и хорошо" },
        ];

        // Правильная последовательность ID событий
        const correctSequence = [4, 7, 3, 5, 2, 6, 1];

        document.addEventListener('DOMContentLoaded', function() {
            const sortableList = document.getElementById('sortable-list');
            let draggedItem = null;

            // Перемешиваем события для начального отображения
            const shuffledEvents = [...eventsData].sort(() => Math.random() - 0.5);

            shuffledEvents.forEach(item => {
                const listItem = document.createElement('div');
                listItem.classList.add('list-group-item', 'list-group-item-action', 'sortable-item');
                listItem.textContent = item.text;
                listItem.draggable = true;
                listItem.dataset.id = item.id; // Сохраняем оригинальный ID
                sortableList.appendChild(listItem);

                listItem.addEventListener('dragstart', function() {
                    draggedItem = this;
                    setTimeout(() => this.classList.add('dragging'), 0);
                });

                listItem.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    draggedItem = null;
                });
            });

            sortableList.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(sortableList, e.clientY);
                const currentDraggingItem = document.querySelector('.dragging');
                if (currentDraggingItem) { // Убедимся, что currentDraggingItem не null
                    if (afterElement == null) {
                        sortableList.appendChild(currentDraggingItem);
                    } else {
                        sortableList.insertBefore(currentDraggingItem, afterElement);
                    }
                }
            });
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.sortable-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            document.getElementById('check-sequence-button').addEventListener('click', function() {
                const items = sortableList.querySelectorAll('.sortable-item');
                const currentSequence = [];
                items.forEach(item => {
                    currentSequence.push(parseInt(item.dataset.id));
                    item.classList.remove('correct-sequence', 'incorrect-sequence'); // Сброс подсветки
                });

                const feedbackEl = document.getElementById('quest-feedback');
                let isCorrect = true;

                if (currentSequence.length !== correctSequence.length) {
                    isCorrect = false; // На всякий случай, если что-то пошло не так
                } else {
                    for (let i = 0; i < correctSequence.length; i++) {
                        if (currentSequence[i] !== correctSequence[i]) {
                            isCorrect = false;
                            items[i].classList.add('incorrect-sequence');
                        } else {
                            items[i].classList.add('correct-sequence');
                        }
                    }
                }
                
                // Подсвечиваем все элементы, если порядок неверный, но какой-то элемент на своем месте
                if (!isCorrect) {
                    items.forEach((item, i) => {
                        if (currentSequence[i] !== correctSequence[i]) {
                             item.classList.add('incorrect-sequence');
                        } else if (!item.classList.contains('correct-sequence')) { // Если не был помечен как правильный
                             item.classList.add('correct-sequence'); // Помечаем как правильный на своем месте
                        }
                    });
                }


                if (isCorrect) {
                    feedbackEl.textContent = 'Последовательность верна! Отлично!';
                    feedbackEl.className = 'quest-feedback-message correct';
                    document.getElementById('next-quest-button').classList.remove('d-none');
                    this.disabled = true;
                    // Блокируем дальнейшее перетаскивание
                    items.forEach(item => item.draggable = false);
                    sortableList.removeEventListener('dragover', arguments.callee); // Удаляем обработчик dragover
                } else {
                    feedbackEl.textContent = 'Последовательность неверна. Попробуйте еще раз, перемещая блоки.';
                    feedbackEl.className = 'quest-feedback-message incorrect';
                }
            });
        });
    </script>
</body>
</html>