<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квест 4: Восстанови последовательность - Мир Чехова</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
</head>

<body class="quest-active">

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../logo.png" alt="Логотип Квеста" width="30" height="30"
                    class="d-inline-block align-text-top me-2">
                <span class="brand-main-text">Мир Чехова</span>
                <span class="brand-tagline ms-2">| грустные оптимисты</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../1/quest_page_1.html">
                            <span class="quest-label d-block">Квест 1:</span>
                            <span class="quest-title d-block">Шуточка</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../2/quest_page_1.html">
                            <span class="quest-label d-block">Квест 2:</span>
                            <span class="quest-title d-block">Толстый и тонкий</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../3/quest_page_1.html">
                            <span class="quest-label d-block">Квест 3:</span>
                            <span class="quest-title d-block">Злоумышленник</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../4/quest_page_1.html">
                            <span class="quest-label d-block">Квест 4:</span>
                            <span class="quest-title d-block">Спать хочется</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../5/quest_page_1.html">
                            <span class="quest-label d-block">Квест 5:</span>
                            <span class="quest-title d-block">Дорогая собака</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../6/quest_page_1.html">
                            <span class="quest-label d-block">Квест 6:</span>
                            <span class="quest-title d-block">Пари</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../7/quest_page_1.html">
                            <span class="quest-label d-block">Квест 7:</span>
                            <span class="quest-title d-block">Не в духе</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../8/quest_page_1.html">
                            <span class="quest-label d-block">Квест 8:</span>
                            <span class="quest-title d-block">Биография</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

        <main class="container quest-page-container my-5 pt-4 pb-5">
        <div class="row w-100">
            <div class="col-12 text-center mb-3">
                <h1 class="quest-question">Финальное задание!</h1>
                <p class="lead text-muted px-md-5">Вы отлично справились с заданиями! Теперь пора раскрыть тайну, о которой мы говорили в начале. Переставьте буквы так, чтобы получилось словосочетание.</p>
            </div>
        </div>

        <!-- Целевые ячейки для составления фразы -->
        <div class="row justify-content-center mb-4">
            <div class="col-auto">
                <div id="target-phrase-area" class="d-flex flex-wrap justify-content-center align-items-center">
                    <!-- Ячейки для первого слова "путь" (4 буквы) -->
                    <div class="target-word-group me-3" id="word-group-1">
                        <!-- Ячейки будут добавлены JS -->
                    </div>
                    <!-- Ячейки для второго слова "самопознания" (12 букв) -->
                    <div class="target-word-group" id="word-group-2">
                        <!-- Ячейки будут добавлены JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Бассейн с перемешанными буквами -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-10 col-xl-8">
                <div id="jumbled-letters-pool" class="p-3 border rounded bg-light shadow-sm d-flex flex-wrap justify-content-center align-items-center" style="min-height: 100px;">
                    <!-- Буквы будут добавлены JS -->
                    <p class="text-muted placeholder-text-pool m-0">Перетащите буквы наверх, чтобы составить фразу.</p>
                </div>
            </div>
        </div>

        <!-- Кнопки управления и обратная связь -->
        <div class="row w-100 mt-4">
            <div class="col-12 text-center">
                <button id="check-phrase-btn" class="btn btn-primary btn-lg px-4 me-2">Проверить фразу</button>
                <button id="reset-phrase-btn" class="btn btn-outline-secondary btn-lg px-4">Сбросить</button>
                <p id="phrase-feedback" class="quest-feedback-message fs-5 mt-3"> </p>
                <!-- Сообщение об успехе (изначально скрыто) -->
                <div id="success-message-container" class="mt-4 d-none">
                    <h3 class="text-success">Великолепно! Тайна раскрыта!</h3>
                    <p class="fs-4">Именно <strong class="text-accent-dark">НЕУДАЧА</strong> связана с проигрышем станового пристава Семёна Ильича Прачкина в карты!</p>
                    <!-- Сюда можно добавить финальную кнопку "Завершить квест" или что-то подобное, если нужно -->
                     <a href="../index.html" class="btn btn-start-quest btn-lg mt-3">Вернуться на главную</a>
                </div>
            </div>
        </div>
    </main>

    <div id="chekhov-corner">
        <img src="../placeholder-chekhov.png" alt="Антон Чехов" title="Антон Павлович Чехов">
    </div>

    <footer class="footer mt-auto py-3">
        <div class="container text-center">
            <span class="text-muted">© 2024 Литературный квест "Мир Чехова". Все права защищены.</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
        <script>
        document.addEventListener('DOMContentLoaded', () => {
            const targetPhrase = "неудача"; // Без пробела для внутреннего представления
            const wordLengths = [7]; // Длины слов "путь", "самопознания"
            const jumbledLetters = shuffleString(targetPhrase);

            const lettersPoolEl = document.getElementById('jumbled-letters-pool');
            const wordGroup1El = document.getElementById('word-group-1');
            const wordGroup2El = document.getElementById('word-group-2');
            const targetSlots = []; // Массив для хранения всех ячеек

            const checkBtn = document.getElementById('check-phrase-btn');
            const resetBtn = document.getElementById('reset-phrase-btn');
            const feedbackEl = document.getElementById('phrase-feedback');
            const successMessageContainer = document.getElementById('success-message-container');
            const placeholderPoolText = lettersPoolEl.querySelector('.placeholder-text-pool');

            let draggedLetter = null;
            let gameSolved = false;

            function shuffleString(str) {
                return str.split('').sort(() => 0.5 - Math.random()).join('');
            }

            // --- Инициализация игры ---
            function initializeGame() {
                gameSolved = false;
                lettersPoolEl.innerHTML = ''; // Очистить пул
                if (placeholderPoolText) lettersPoolEl.appendChild(placeholderPoolText); // Вернуть плейсхолдер
                
                wordGroup1El.innerHTML = '';
                wordGroup2El.innerHTML = '';
                targetSlots.length = 0; // Очистить массив ячеек

                // Создаем ячейки для слов
                createTargetSlots(wordLengths[0], wordGroup1El);
                createTargetSlots(wordLengths[1], wordGroup2El);

                // Создаем перетаскиваемые буквы
                jumbledLetters.split('').forEach(letterChar => {
                    const letterEl = document.createElement('div');
                    letterEl.classList.add('draggable-letter');
                    letterEl.textContent = letterChar;
                    letterEl.draggable = true;
                    letterEl.dataset.letter = letterChar; // Сохраняем букву
                    addDragListeners(letterEl);
                    lettersPoolEl.appendChild(letterEl);
                });
                
                if (placeholderPoolText && lettersPoolEl.children.length > 1) {
                    placeholderPoolText.classList.add('d-none');
                } else if (placeholderPoolText) {
                     placeholderPoolText.classList.remove('d-none');
                }


                feedbackEl.textContent = ' ';
                feedbackEl.className = 'quest-feedback-message fs-5 mt-3';
                successMessageContainer.classList.add('d-none');
                checkBtn.disabled = false;
                resetBtn.disabled = false;
            }

            function createTargetSlots(count, parentEl) {
                for (let i = 0; i < count; i++) {
                    const slotEl = document.createElement('div');
                    slotEl.classList.add('target-letter-slot');
                    slotEl.dataset.index = targetSlots.length; // Глобальный индекс ячейки
                    addDropListeners(slotEl);
                    parentEl.appendChild(slotEl);
                    targetSlots.push(slotEl);
                }
            }

            // --- Логика Drag-and-Drop ---
            function addDragListeners(element) {
                element.addEventListener('dragstart', (e) => {
                    if (gameSolved) { e.preventDefault(); return; }
                    draggedLetter = element;
                    setTimeout(() => element.classList.add('dragging'), 0);
                    // e.dataTransfer.setData('text/plain', element.dataset.letter); // Можно для совместимости
                });

                element.addEventListener('dragend', () => {
                    element.classList.remove('dragging');
                });
            }

            function addDropListeners(element) { // element это target-letter-slot или lettersPoolEl
                element.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (gameSolved) return;
                    element.classList.add('drag-over');
                });

                element.addEventListener('dragleave', () => {
                    element.classList.remove('drag-over');
                });

                element.addEventListener('drop', (e) => {
                    e.preventDefault();
                    if (gameSolved || !draggedLetter) return;
                    element.classList.remove('drag-over');

                    if (element.classList.contains('target-letter-slot')) { // Если бросаем в ячейку
                        if (!element.hasChildNodes()) { // Если ячейка пуста
                            element.appendChild(draggedLetter);
                        } else { // Если ячейка занята, меняем местами
                            const existingLetter = element.firstChild;
                            lettersPoolEl.appendChild(existingLetter); // Возвращаем старую букву в пул
                            element.appendChild(draggedLetter);
                            if (placeholderPoolText) placeholderPoolText.classList.add('d-none');
                        }
                    } else if (element.id === 'jumbled-letters-pool') { // Если бросаем обратно в пул
                        element.appendChild(draggedLetter);
                         if (placeholderPoolText && element.children.length > 1) {
                            placeholderPoolText.classList.add('d-none');
                        }
                    }
                    draggedLetter = null;
                });
            }
            
            // Добавляем возможность возвращать буквы в пул
            addDropListeners(lettersPoolEl);


            // --- Проверка фразы ---
            checkBtn.addEventListener('click', () => {
                if (gameSolved) return;

                let assembledPhrase = "";
                let allSlotsFilled = true;

                targetSlots.forEach(slot => {
                    if (slot.hasChildNodes() && slot.firstChild.classList.contains('draggable-letter')) {
                        assembledPhrase += slot.firstChild.dataset.letter;
                    } else {
                        allSlotsFilled = false;
                    }
                });

                if (!allSlotsFilled) {
                    feedbackEl.textContent = 'Пожалуйста, заполните все ячейки буквами.';
                    feedbackEl.className = 'quest-feedback-message incorrect fs-5 mt-3';
                    return;
                }

                // Очистка предыдущей подсветки букв в ячейках
                targetSlots.forEach(slot => {
                    if (slot.firstChild) {
                        slot.firstChild.classList.remove('correct-in-slot', 'incorrect-in-slot');
                    }
                });

                if (assembledPhrase === targetPhrase) {
                    gameSolved = true;
                    feedbackEl.textContent = 'Верно!';
                    feedbackEl.className = 'quest-feedback-message correct fs-5 mt-3';
                    successMessageContainer.classList.remove('d-none');
                    checkBtn.disabled = true;
                    resetBtn.disabled = true; // Можно и оставить, если хочется
                    // Подсветить все буквы как правильные
                    targetSlots.forEach(slot => {
                         if(slot.firstChild) slot.firstChild.classList.add('correct-in-slot');
                    });
                } else {
                    feedbackEl.textContent = 'Фраза составлена неверно. Попробуйте еще раз.';
                    feedbackEl.className = 'quest-feedback-message incorrect fs-5 mt-3';
                    // Можно добавить побуквенную подсветку, если нужно
                    // for (let i = 0; i < targetPhrase.length; i++) {
                    //     if (targetSlots[i].firstChild) {
                    //        if (targetSlots[i].firstChild.dataset.letter === targetPhrase[i]) {
                    //            targetSlots[i].firstChild.classList.add('correct-in-slot');
                    //        } else {
                    //            targetSlots[i].firstChild.classList.add('incorrect-in-slot');
                    //        }
                    //     }
                    // }
                }
            });

            // --- Сброс игры ---
            resetBtn.addEventListener('click', () => {
                initializeGame();
            });

            // --- Первый запуск ---
            initializeGame();
        });
    </script>
</body>

</html>