<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Квест 4: Восстанови последовательность - Мир Чехова</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&family=Lora:ital,wght@0,400..700;1,400..700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
</head>

<body class="quest-active">

    <nav class="navbar navbar-expand-lg navbar-custom fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="../index.html">
                <img src="../logo.png" alt="Логотип Квеста" width="30" height="30"
                    class="d-inline-block align-text-top me-2">
                <span class="brand-main-text">Мир Чехова</span>
                <span class="brand-tagline ms-2">| грустные оптимисты</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../1/quest_page_1.html">
                            <span class="quest-label d-block">Квест 1:</span>
                            <span class="quest-title d-block">Шуточка</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../2/quest_page_1.html">
                            <span class="quest-label d-block">Квест 2:</span>
                            <span class="quest-title d-block">Толстый и тонкий</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../3/quest_page_1.html">
                            <span class="quest-label d-block">Квест 3:</span>
                            <span class="quest-title d-block">Злоумышленник</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../4/quest_page_1.html">
                            <span class="quest-label d-block">Квест 4:</span>
                            <span class="quest-title d-block">Спать хочется</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../5/quest_page_1.html">
                            <span class="quest-label d-block">Квест 5:</span>
                            <span class="quest-title d-block">Дорогая собака</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../6/quest_page_1.html">
                            <span class="quest-label d-block">Квест 6:</span>
                            <span class="quest-title d-block">Пари</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../7/quest_page_1.html">
                            <span class="quest-label d-block">Квест 7:</span>
                            <span class="quest-title d-block">Не в духе</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-center" href="../8/quest_page_1.html">
                            <span class="quest-label d-block">Квест 8:</span>
                            <span class="quest-title d-block">Биография</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <main class="container quest-page-container my-5 pt-4 pb-5">
        <div class="row w-100">
            <div class="col-12 text-center mb-4">
                <h2 class="quest-question">ДО - ПОСЛЕ</h2>
                <p class="lead text-muted">После того как Тонкий узнал о высоком чине друга, его речь разительно изменилась. Какие из этих фраз произнес Тонкий ПОСЛЕ известия о чине Толстого, а какие ДО?</p>
            </div>
        </div>

        <!-- Drop Zones and Unassigned Quotes Pool -->
        <div class="row justify-content-around" id="matching-area">
            <!-- Column for Lawyer -->
            <div class="col-md-5 mb-4">
                <div class="speaker-zone p-3 border rounded bg-light shadow-sm">
                    <h3 class="text-center mb-3 speaker-name" data-speaker="lawyer">До:</h3>
                    <div class="drop-target" id="lawyer-drop-zone" data-speaker-target="lawyer">
                        <!-- Dropped quotes for lawyer will appear here -->
                        <p class="text-muted small text-center placeholder-text">Цитаты ДО</p>
                    </div>
                </div>
            </div>

            <!-- Column for Banker -->
            <div class="col-md-5 mb-4">
                <div class="speaker-zone p-3 border rounded bg-light shadow-sm">
                    <h3 class="text-center mb-3 speaker-name" data-speaker="banker">После:</h3>
                    <div class="drop-target" id="banker-drop-zone" data-speaker-target="banker">
                        <!-- Dropped quotes for banker will appear here -->
                        <p class="text-muted small text-center placeholder-text">Цитаты ПОСЛЕ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pool of Draggable Quotes -->
        <div class="row mt-2 mb-4 justify-content-center">
            <div class="col-lg-10">
                <h4 class="text-center mb-3">Цитаты для распределения:</h4>
                <div id="quotes-pool" class="d-flex flex-wrap justify-content-center p-2 border rounded bg-white">
                    <!-- Quotes will be injected here by JS or listed directly -->
                    <div class="quote-item p-2 m-1 border rounded bg-light-beige shadow-sm" draggable="true" id="quote1"
                        data-correct-speaker="banker">
                        "Ваше превосходительство... Хи-хи-с. Очень приятно-с!"
                    </div>
                    <div class="quote-item p-2 m-1 border rounded bg-light-beige shadow-sm" draggable="true" id="quote2"
                        data-correct-speaker="banker">
                        "Я, ваше превосходительство... женой моей Луизой, урожденной Ванценбах... лютеранкой-с..."
                    </div>
                    <div class="quote-item p-2 m-1 border rounded bg-light-beige shadow-sm" draggable="true" id="quote3"
                        data-correct-speaker="lawyer">
                         "Милый мой! Сколько лет, сколько зим!"
                    </div>
                    <div class="quote-item p-2 m-1 border rounded bg-light-beige shadow-sm" draggable="true" id="quote3"
                        data-correct-speaker="lawyer">
                         "Ну, как ты? Богат? Женат?"
                    </div>
                </div>
            </div>
        </div>

        <div class="row w-100 mt-4">
            <div class="col-12 text-center">
                <button id="check-matches-btn" class="btn btn-primary btn-lg px-5">Проверить соотнесение</button>
                <p id="matching-feedback" class="quest-feedback-message fs-5 mt-3"> </p>
                <!-- ЗАМЕНИТЕ "path/to/next_quest_page.html" на актуальный путь -->
                <a href="quest_page_9.html" id="next-quest-button"
                    class="btn btn-start-quest btn-lg d-none mt-2">Следующий этап</a>
            </div>
        </div>
    </main>

    <footer class="footer mt-auto py-3">
        <div class="container text-center">
            <span class="text-muted">© 2024 Литературный квест "Мир Чехова". Все права защищены.</span>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const quoteItems = document.querySelectorAll('.quote-item');
            const dropTargets = document.querySelectorAll('.drop-target');
            const quotesPool = document.getElementById('quotes-pool');
            const checkButton = document.getElementById('check-matches-btn');
            const feedbackEl = document.getElementById('matching-feedback');
            const nextQuestButton = document.getElementById('next-quest-button');

            let draggedItem = null;
            let isProcessingAnswer = false; // Флаг, что идет проверка или ожидание сброса

            // --- Drag and Drop Event Handlers ---
            quoteItems.forEach(item => {
                item.addEventListener('dragstart', function (e) {
                    if (isProcessingAnswer) {
                        e.preventDefault();
                        return;
                    }
                    draggedItem = this;
                    setTimeout(() => this.classList.add('dragging'), 0);
                });

                item.addEventListener('dragend', function () {
                    this.classList.remove('dragging');
                });
            });

            dropTargets.forEach(target => {
                target.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    if (isProcessingAnswer) return;
                    this.classList.add('drag-over');
                });

                target.addEventListener('dragleave', function () {
                    this.classList.remove('drag-over');
                });

                target.addEventListener('drop', function (e) {
                    e.preventDefault();
                    if (isProcessingAnswer || !draggedItem) return;

                    this.classList.remove('drag-over');

                    const placeholder = this.querySelector('.placeholder-text');
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }

                    this.appendChild(draggedItem);
                    draggedItem = null;
                });
            });

            quotesPool.addEventListener('dragover', function (e) {
                e.preventDefault();
                if (isProcessingAnswer) return;
                this.classList.add('drag-over');
            });
            quotesPool.addEventListener('dragleave', function () {
                this.classList.remove('drag-over');
            });
            quotesPool.addEventListener('drop', function (e) {
                e.preventDefault();
                if (isProcessingAnswer || !draggedItem) return;
                this.classList.remove('drag-over');
                this.appendChild(draggedItem);
                draggedItem = null;
            });

            // --- Function to Reset Quiz State ---
            function resetMatchingQuiz() {
                // Move all quotes back to the pool
                dropTargets.forEach(zone => {
                    const quotesInZone = Array.from(zone.querySelectorAll('.quote-item')); // Create static array
                    quotesInZone.forEach(quote => {
                        quotesPool.appendChild(quote);
                        quote.classList.remove('correct-match', 'incorrect-match');
                    });
                    // Show placeholder if zone is now empty
                    const placeholder = zone.querySelector('.placeholder-text');
                    if (placeholder && zone.querySelectorAll('.quote-item').length === 0) {
                        placeholder.classList.remove('hidden');
                    }
                });

                // Ensure all original quotes are in the pool (in case some were not moved before)
                // This can be more robust by having a master list of quote IDs if needed.
                // For now, the above should suffice if all items start in the pool.

                quoteItems.forEach(item => {
                    item.setAttribute('draggable', 'true');
                    item.classList.remove('correct-match', 'incorrect-match'); // Ensure all are clean
                });

                isProcessingAnswer = false;
                checkButton.disabled = false;
                feedbackEl.textContent = ' '; // Clear feedback
                feedbackEl.className = 'quest-feedback-message fs-5 mt-3'; // Reset feedback class
                nextQuestButton.classList.add('d-none'); // Hide next button
            }

            // --- Check Button Event Handler ---
            checkButton.addEventListener('click', () => {
                if (isProcessingAnswer) return;

                let allCorrect = true;

                // Check if all quotes are placed out of the initial pool
                if (quotesPool.querySelectorAll('.quote-item').length > 0) {
                    feedbackEl.textContent = 'Пожалуйста, распределите все цитаты.';
                    feedbackEl.className = 'quest-feedback-message incorrect fs-5 mt-3'; // Используем ваш класс
                    return;
                }
                // Clear "распределите все" message if it was shown previously
                if (feedbackEl.textContent === 'Пожалуйста, распределите все цитаты.') {
                    feedbackEl.textContent = ' ';
                    feedbackEl.className = 'quest-feedback-message fs-5 mt-3';
                }


                isProcessingAnswer = true; // Block interactions
                checkButton.disabled = true;
                quoteItems.forEach(item => item.setAttribute('draggable', 'false'));

                dropTargets.forEach(zone => {
                    const zoneSpeaker = zone.dataset.speakerTarget;
                    const quotesInZone = zone.querySelectorAll('.quote-item');

                    quotesInZone.forEach(quote => {
                        const correctSpeaker = quote.dataset.correctSpeaker;
                        if (correctSpeaker === zoneSpeaker) {
                            quote.classList.add('correct-match');    // Используем ваш класс
                            quote.classList.remove('incorrect-match'); // Используем ваш класс
                        } else {
                            quote.classList.add('incorrect-match');  // Используем ваш класс
                            quote.classList.remove('correct-match'); // Используем ваш класс
                            allCorrect = false;
                        }
                    });
                });

                if (allCorrect) {
                    feedbackEl.textContent = 'Отлично! Все цитаты соотнесены верно.';
                    feedbackEl.className = 'quest-feedback-message correct fs-5 mt-3'; // Используем ваш класс
                    nextQuestButton.classList.remove('d-none');
                    // No reset needed, quiz is solved for this page
                } else {
                    feedbackEl.textContent = 'Некоторые цитаты соотнесены неверно. Попробуйте снова через 10 секунд.';
                    feedbackEl.className = 'quest-feedback-message incorrect fs-5 mt-3'; // Используем ваш класс

                    setTimeout(() => {
                        resetMatchingQuiz();
                    }, 10000); // 10-second delay
                }
            });
        });
    </script>
</body>

</html>